<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Aproveitamento de Estudos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .disciplina {
      background: #fff; padding: 15px; margin-bottom: 20px;
      border: 1px solid #ccc; border-radius: 8px;
    }
    label { display: block; margin-top: 10px; }
    input, select {
      width: 100%; padding: 6px; margin-top: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 14px; font-size: 14px; margin-top: 10px;
      cursor: pointer;
    }
    .ies-externa {
      display: none;
    }
  </style>
</head>
<body>
  <h2>Solicitação de Aproveitamento de Estudos</h2>

  <div id="disciplinas">
    <div class="disciplina">
      <label>IES de origem:
        <select class="ies-select" onchange="mostrarCampoIES(this)">
          <option value="UFMT">UFMT</option>
          <option value="Externa">Externa</option>
        </select>
      </label>
      <label class="ies-externa">
        Qual instituição?
        <input type="text" class="ies-outra" placeholder="Nome da instituição" />
      </label>

      <label>Disciplina cursada:
        <input type="text" class="disciplina-cursada" placeholder="Ex: Álgebra Linear" />
      </label>
      <label>Código da cursada:
        <input type="text" class="codigo-cursada" placeholder="Ex: MAT123" />
      </label>
      <label>Nota:
        <input type="text" class="nota" placeholder="Ex: 8.5" />
      </label>
      <label>Disciplina a aproveitar:
        <select class="disciplina-aproveitar" onchange="atualizarDisciplina(this)">
          <option value="">Carregando...</option>
        </select>
      </label>
      <label>Código da a aproveitar:
        <input type="text" readonly class="codigo-aproveitar" />
      </label>
    </div>
  </div>

  <button onclick="addDisciplina()">Adicionar outra disciplina</button>
  <button onclick="gerarPDF()">Gerar PDF</button>

  <script>
    // Mostrar campo instituição externa
    function mostrarCampoIES(select) {
      const externaDiv = select.parentElement.parentElement.querySelector(".ies-externa");
      if (select.value === "Externa") {
        externaDiv.style.display = "block";
      } else {
        externaDiv.style.display = "none";
        externaDiv.querySelector("input").value = "";
      }
    }

    // Atualizar código da disciplina a aproveitar quando selecionada
    function atualizarDisciplina(select) {
      const inputCodigo = select.parentElement.parentElement.querySelector(".codigo-aproveitar");
      inputCodigo.value = select.value;
    }

    // Popular selects disciplina-aproveitar com dados do disciplinas.json
    async function popularSelectDisciplina() {
      try {
        const response = await fetch('disciplinas.json');
        const disciplinasJSON = await response.json();

        const selects = document.querySelectorAll(".disciplina-aproveitar");

        selects.forEach(select => {
          select.innerHTML = `<option value="">Selecione</option>`;
          disciplinasJSON.forEach(d => {
            const option = document.createElement("option");
            option.value = d.codigo;
            option.textContent = `${d.codigo} - ${d.nome}`;
            select.appendChild(option);
          });
        });
      } catch (error) {
        console.error("Erro ao carregar disciplinas.json:", error);
        // Caso dê erro, deixa a opção padrão
        const selects = document.querySelectorAll(".disciplina-aproveitar");
        selects.forEach(select => {
          select.innerHTML = `<option value="">Erro ao carregar disciplinas</option>`;
        });
      }
    }

    // Adicionar nova disciplina (clona o primeiro bloco e reseta valores)
    function addDisciplina() {
      const container = document.getElementById("disciplinas");
      const nova = container.firstElementChild.cloneNode(true);

      nova.querySelectorAll("input").forEach(input => input.value = "");
      nova.querySelectorAll("select").forEach(sel => sel.selectedIndex = 0);
      nova.querySelector(".ies-externa").style.display = "none";

      container.appendChild(nova);

      popularSelectDisciplina();
    }

    // Gerar PDF com os dados preenchidos
    async function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const disciplinas = document.querySelectorAll(".disciplina");
      let y = 15;
      const lineHeight = 7;
      const pageHeight = 280;

      doc.setFontSize(9);

      disciplinas.forEach((d, i) => {
        if (y + 30 > pageHeight) {
          doc.addPage();
          y = 15;
        }

        // Cabeçalho em negrito
        doc.setFont("helvetica", "bold");
        doc.text(`Disciplina ${i + 1}:`, 10, y);
        y += lineHeight;

        doc.text("IES", 10, y);
        doc.text("Disciplina Cursada", 35, y);
        doc.text("Código", 85, y);
        doc.text("Nota", 110, y);
        doc.text("Aproveitar como", 130, y);
        doc.text("Código", 175, y);
        y += lineHeight;

        // Dados em fonte normal
        doc.setFont("helvetica", "normal");

        const ies = d.querySelector(".ies-select").value;
        const iesOutro = d.querySelector(".ies-outra").value;
        const origem = ies === "Externa" ? iesOutro || "-" : "UFMT";

        const cursada = d.querySelector(".disciplina-cursada").value || "-";
        const codCursada = d.querySelector(".codigo-cursada").value || "-";
        const nota = d.querySelector(".nota").value || "-";

        const selectAproveitar = d.querySelector("select.disciplina-aproveitar");
        const aproveitada = selectAproveitar.options[selectAproveitar.selectedIndex]?.text.split(" - ")[1] || "-";
        const codAproveitar = d.querySelector(".codigo-aproveitar").value || "-";

        // Colunas
        const xIES = 10;
        const wIES = 20;

        const xCursada = 35;
        const wCursada = 45;

        const xCodCursada = 85;
        const wCodCursada = 20;

        const xNota = 110;
        const wNota = 15;

        const xAproveitar = 130;
        const wAproveitar = 40;

        const xCodAproveitar = 175;
        const wCodAproveitar = 25;

        // Quebrar linhas longas
        const iesLines = doc.splitTextToSize(origem, wIES);
        const cursadaLines = doc.splitTextToSize(cursada, wCursada);
        const codCursadaLines = doc.splitTextToSize(codCursada, wCodCursada);
        const notaLines = doc.splitTextToSize(nota, wNota);
        const aproveitarLines = doc.splitTextToSize(aproveitada, wAproveitar);
        const codAproveitarLines = doc.splitTextToSize(codAproveitar, wCodAproveitar);

        const maxLines = Math.max(
          iesLines.length,
          cursadaLines.length,
          codCursadaLines.length,
          notaLines.length,
          aproveitarLines.length,
          codAproveitarLines.length
        );

        // Imprimir colunas
        doc.text(iesLines, xIES, y);
        doc.text(cursadaLines, xCursada, y);
        doc.text(codCursadaLines, xCodCursada, y);
        doc.text(notaLines, xNota, y);
        doc.text(aproveitarLines, xAproveitar, y);
        doc.text(codAproveitarLines, xCodAproveitar, y);

        y += lineHeight * maxLines * 1.5;
      });

      doc.save("aproveitamento_estudos.pdf");
    }

    // Carrega as disciplinas no carregamento da página
    document.addEventListener("DOMContentLoaded", () => {
      popularSelectDisciplina();
    });
  </script>
</body>
</html>

<!DOCTYPE html>

<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Aproveitamento de Estudos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h2>Solicitação de Aproveitamento de Estudos</h2>

  <div id="disciplinas">
    <div class="disciplina">
      <label>IES de origem:
        <select class="ies-select" onchange="mostrarCampoIES(this)">
          <option value="UFMT">UFMT</option>
          <option value="Externa">Externa</option>
        </select>
      </label>
      <label class="ies-externa">
        Qual instituição?
        <input type="text" class="ies-outra" placeholder="Nome da instituição" />
      </label>

      <label>Disciplina cursada:
        <input type="text" class="disciplina-cursada" placeholder="Ex: Álgebra Linear" />
      </label>
      <label>Código da cursada:
        <input type="text" class="codigo-cursada" placeholder="Ex: MAT123" />
      </label>
      <label>Nota:
        <input type="text" class="nota" placeholder="Ex: 8.5" />
      </label>
      <label>Disciplina a aproveitar:
        <select class="disciplina-aproveitar" onchange="atualizarDisciplina(this)">
          <option value="">Carregando...</option>
        </select>
      </label>
      <label>Código da a aproveitar:
        <input type="text" readonly class="codigo-aproveitar" />
      </label>
    </div>
  </div>

  <button onclick="addDisciplina()">Adicionar outra disciplina</button>
  <button onclick="gerarPDF()">Gerar PDF</button>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  let disciplinas = [];

  // Carrega estilos externos
  const link = document.createElement("link");
  link.rel = "stylesheet";
  link.href = "styles.css"; // certifique-se de que o caminho esteja correto
  document.head.appendChild(link);

  // Carrega lista de disciplinas
  fetch("disciplinas.json")
    .then(res => res.json())
    .then(data => {
      disciplinas = data;
      preencherSelects();
    })
    .catch(err => console.error("Erro ao carregar disciplinas:", err));

  function preencherSelects() {
    document.querySelectorAll(".disciplina-cursada, .disciplina-aproveitar").forEach(select => {
      select.innerHTML = "<option value=''>Selecione</option>";
      disciplinas.forEach(d => {
        const option = document.createElement("option");
        option.value = d.codigo;
        option.textContent = `${d.codigo} - ${d.nome}`;
        select.appendChild(option);
      });
    });
  }

  document.getElementById("adicionarDisciplina").addEventListener("click", () => {
    const container = document.getElementById("disciplinasContainer");
    const modelo = document.querySelector(".disciplina");
    const clone = modelo.cloneNode(true);
    limparCampos(clone);
    container.appendChild(clone);
    preencherSelects(); // Preenche o select da nova disciplina
  });

  function limparCampos(container) {
    container.querySelectorAll("input, select").forEach(el => {
      el.value = "";
    });
  }

  document.getElementById("gerarPDF").addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 20;
    const lineHeight = 7;

    document.querySelectorAll(".disciplina").forEach((div, index) => {
      const cursada = div.querySelector(".disciplina-cursada").value;
      const codigoCursada = disciplinas.find(d => d.codigo === cursada)?.codigo || "";
      const nomeCursada = disciplinas.find(d => d.codigo === cursada)?.nome || "";

      const aproveitar = div.querySelector(".disciplina-aproveitar").value;
      const codigoAproveitar = disciplinas.find(d => d.codigo === aproveitar)?.codigo || "";
      const nomeAproveitar = disciplinas.find(d => d.codigo === aproveitar)?.nome || "";

      const ies = div.querySelector(".ies").value;
      const externa = div.querySelector(".ies-externa").value;

      const linhas = [
        `Disciplina Cursada: ${codigoCursada} - ${nomeCursada}`,
        `Disciplina a Aproveitar: ${codigoAproveitar} - ${nomeAproveitar}`,
        `IES: ${ies}${ies === 'Externa' ? ` (${externa})` : ""}`
      ];

      let maxLines = 0;
      linhas.forEach((linha, i) => {
        const split = doc.splitTextToSize(linha, 170);
        maxLines = Math.max(maxLines, split.length);
        split.forEach((txt, j) => {
          doc.text(txt, 20, y + (lineHeight * j));
        });
        y += lineHeight * split.length;
      });

      y += 5;

      if (y > 270 && index < document.querySelectorAll(".disciplina").length - 1) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save("aproveitamento_estudos.pdf");
  });

  // Mostrar campo externa se IES for "Externa"
  document.addEventListener("change", e => {
    if (e.target.classList.contains("ies")) {
      const externaField = e.target.closest(".disciplina").querySelector(".ies-externa");
      externaField.style.display = e.target.value === "Externa" ? "block" : "none";
    }
  });
});
</script>

</body>
</html>
